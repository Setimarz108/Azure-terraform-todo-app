name: ğŸš€ Deploy Enterprise Todo App to Azure

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  TERRAFORM_VERSION: '1.5.0'

jobs:
  validate-infrastructure:
    name: ğŸ” Validate Infrastructure
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}
    
    - name: ğŸ“ Terraform Format Check
      run: terraform fmt -check
      continue-on-error: true
      
    - name: ğŸ”¨ Terraform Init
      run: terraform init
      
    - name: âœ… Terraform Validate
      run: terraform validate
      
    - name: ğŸ“‹ Terraform Plan
      run: terraform plan -var-file="terraform.tfvars.example"
      continue-on-error: true

  build-application:
    name: ğŸ—ï¸ Build React Application
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: react-todo/package-lock.json
    
    - name: ğŸ“¦ Install Dependencies
      working-directory: ./react-todo
      run: npm ci
    
    - name: ğŸ§ª Run Tests (if available)
      working-directory: ./react-todo
      run: npm test -- --coverage --watchAll=false
      continue-on-error: true
    
    - name: ğŸ—ï¸ Build Application
      working-directory: ./react-todo
      run: npm run build
    
    - name: ğŸ“¤ Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: react-build-${{ github.sha }}
        path: react-todo/dist/
        retention-days: 30

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: ğŸ“¦ Install Dependencies
      working-directory: ./react-todo
      run: npm ci
    
    - name: ğŸ” Run Security Audit
      working-directory: ./react-todo
      run: npm audit --audit-level moderate
      continue-on-error: true

  deploy-infrastructure:
    name: ğŸŒ©ï¸ Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [validate-infrastructure, build-application]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}
        terraform_wrapper: false
    
    # For now, just validate - we'll add deployment secrets later
    - name: ğŸ”¨ Terraform Init
      run: terraform init
      
    - name: ğŸ“‹ Terraform Plan
      run: terraform plan -var-file="terraform.tfvars.example"
      
    - name: ğŸ’¬ Comment Plan on PR
      if: github.event_name == 'pull_request'
      run: echo "Terraform plan completed successfully"

  deploy-application:
    name: ğŸš€ Deploy Application
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, build-application]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: react-build-${{ github.sha }}
        path: ./build
    
    - name: ğŸ“‹ List Build Contents
      run: ls -la ./build
      
    # For now, just show what would be deployed
    - name: âœ… Deployment Ready
      run: echo "Application build artifacts ready for deployment"

  notification:
    name: ğŸ“¢ Notify Status
    runs-on: ubuntu-latest
    needs: [validate-infrastructure, build-application, security-scan]
    if: always()
    
    steps:
    - name: ğŸ‰ Success Notification
      if: ${{ needs.validate-infrastructure.result == 'success' && needs.build-application.result == 'success' }}
      run: |
        echo "âœ… Pipeline completed successfully!"
        echo "ğŸ“Š Infrastructure validated"
        echo "ğŸ—ï¸ Application built"
        echo "ğŸ”’ Security scan completed"
        
    - name: âŒ Failure Notification
      if: ${{ needs.validate-infrastructure.result == 'failure' || needs.build-application.result == 'failure' }}
      run: |
        echo "âŒ Pipeline failed!"
        echo "Please check the logs above"